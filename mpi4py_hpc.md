# Memo â€“ Fixing `mpi4py` Module Issue on Compute Canada (Cedar)

## Problem

Your SLURM job was crashing with the error:

```
ModuleNotFoundError: No module named 'mpi4py'
```

Even after installing `mpi4py` inside your Python virtual environment (`fedcifar`), the installation failed with:

```
This is a normal error generated by this dummy wheel.
mpi4py is available from the mpi4py module...
```

---

## Root Cause

On Cedar, the `mpi4py` package is not meant to be installed via pip from PyPI.

Instead, it is made available via a precompiled module that must be:

1. Loaded using `module load`
2. Before activating your Python virtual environment

If this order is not respected, pip sees a dummy placeholder wheel that intentionally fails.

---

## Correct Manual Setup

### 1. Deactivate any active virtual environment:
```bash
deactivate
```

### 2. Purge modules and load required environment:
```bash
module purge
module load StdEnv/2023
module load python/3.11
module load openmpi/4.1.5
module load mpi4py/4.0.3
```

### 3. Activate your virtual environment:
```bash
source ~/venvs/fedcifar/bin/activate
```

No need to `pip install mpi4py`. It is now accessible through the environment.

---

## Test That It Works

```bash
python -c "from mpi4py import MPI; print(MPI.Get_version())"
```

Expected output:

```
(3, 1)
```

This confirms `mpi4py` is available and working.

---

## SLURM Integration

In your SLURM script (`run_federated.sh`), ensure modules are loaded before activating the venv:

```bash
module purge
module load StdEnv/2023
module load python/3.11
module load openmpi/4.1.5
module load mpi4py/4.0.3

source ~/venvs/fedcifar/bin/activate
```

---

## Summary

- `mpi4py` must be loaded as a module, not installed via pip
- Load it before activating your virtualenv
- Do not run `pip install mpi4py` after activating the venv